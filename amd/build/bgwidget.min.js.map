{"version":3,"file":"bgwidget.min.js","sources":["../src/bgwidget.js"],"sourcesContent":["require.config({\n    paths: {\n        'jquery-ui': '/blocks/bgwidget/lib/jquery-ui-1.14.1.custom/jquery-ui-wrapper',\n        'chatConfig': '/blocks/bgwidget/amd/src/chatConfig'\n    },\n    shim: {\n        'jquery-ui': {\n            deps: ['jquery'],\n            exports: 'jQuery.ui'\n        }\n    }\n});\n\ndefine('bgwidget', ['jquery', 'jquery-ui', 'chatConfig'], function($, ui, chatConfigModule) {\n  const chatConfig = chatConfigModule.chatConfig;\n\n  /**\n   * Initializes the chat widget.\n   */\n  function initialize() {\n    chatConfigModule.setChatConfig();\n    setMessages();\n    setupWidget();\n    loadPreviousMessages();\n    if (!chatConfig.token) {\n      initializeChat();\n    }\n    setupEventListeners();\n  }\n\n  /**\n   * Sets chat messages from sessionStorage.\n   */\n  function setMessages() {\n    chatConfig.token = sessionStorage.getItem(chatConfig.tokenKey) || \"\";\n    chatConfig.messages = JSON.parse(sessionStorage.getItem(chatConfig.messagesKey)) || [];\n  }\n\n  /**\n   * Sets up the chat widget, including size and toggle functionality.\n   */\n  function setupWidget() {\n    const originalSize = getOriginalSize();\n    const initialWidth = getInitialWidth(originalSize);\n    const initialHeight = getInitialHeight(originalSize);\n    setupWidgetToggle(originalSize, initialWidth, initialHeight);\n  }\n\n  /**\n   * Gets the original size of the chat widget.\n   * @returns {Object} An object containing the width and height of the widget.\n   */\n  function getOriginalSize() {\n    return {\n      width: $(\"#chat-widget\").width(),\n      height: $(\"#chat-widget\").height(),\n    };\n  }\n\n  /**\n   * Gets the initial width of the chat widget.\n   * @param {Object} originalSize - The original size of the widget.\n   * @returns {number} The initial width of the widget.\n   */\n  function getInitialWidth(originalSize) {\n    return sessionStorage.getItem(\"widgetWidth\") || originalSize.width;\n  }\n\n  /**\n   * Gets the initial height of the chat widget.\n   * @param {Object} originalSize - The original size of the widget.\n   * @returns {number} The initial height of the widget.\n   */\n  function getInitialHeight(originalSize) {\n    return sessionStorage.getItem(\"widgetHeight\") || originalSize.height;\n  }\n\n  /**\n   * Sets up the toggle functionality for the chat widget.\n   * @param {Object} originalSize - The original size of the widget.\n   * @param {number} initialWidth - The initial width of the widget.\n   * @param {number} initialHeight - The initial height of the widget.\n   */\n  function setupWidgetToggle(originalSize, initialWidth, initialHeight) {\n    $(\"#chat-move-toggle\").on(\"click\", function () {\n      chatConfig.isPinned = !chatConfig.isPinned;\n      $(\"#chat-widget\").toggleClass(\"expanded\", !chatConfig.isPinned);\n\n      if (!chatConfig.isPinned) {\n        handleUnpin(initialWidth, initialHeight);\n      } else {\n        handlePin(originalSize);\n      }\n    });\n  }\n\n  /**\n   * Handles the unpinning of the chat widget.\n   * @param {number} initialWidth - The initial width of the widget.\n   * @param {number} initialHeight - The initial height of the widget.\n   */\n  function handleUnpin(initialWidth, initialHeight) {\n    $(\"#unpinned-message\").show();\n    let savedPosition = JSON.parse(sessionStorage.getItem(\"widgetPosition\"));\n    const savedWidth = sessionStorage.getItem(\"widgetWidth\") || initialWidth;\n    const savedHeight = sessionStorage.getItem(\"widgetHeight\") || initialHeight;\n\n    if (!savedPosition) {\n      savedPosition = calculateCentralPosition(savedWidth, savedHeight);\n    }\n\n    makeWidgetDraggable();\n    makeWidgetResizable();\n\n    $(\"#chat-widget\").css({\n      position: \"fixed\",\n      width: savedWidth,\n      height: savedHeight,\n      top: savedPosition.top,\n      left: savedPosition.left,\n      maxHeight: \"90vh\"\n    });\n\n    $(\"#chat-move-toggle\").find(\"i\").removeClass(\"pinned\").addClass(\"unpinned\");\n  }\n\n  /**\n   * Handles the pinning of the chat widget.\n   * @param {Object} originalSize - The original size of the widget.\n   */\n  function handlePin(originalSize) {\n    $(\"#unpinned-message\").hide();\n    const currentWidth = $(\"#chat-widget\").width();\n    const currentHeight = $(\"#chat-widget\").height();\n\n    sessionStorage.setItem(\"widgetWidth\", currentWidth);\n    sessionStorage.setItem(\"widgetHeight\", currentHeight);\n\n    $(\"#chat-widget\").draggable(\"destroy\");\n    $(\"#chat-widget\").resizable(\"destroy\");\n    $(\"#chat-widget\").css({\n      position: \"static\",\n      width: originalSize.width,\n      height: originalSize.height,\n      maxHeight: \"45vh\"\n    });\n\n    $(\"#chat-move-toggle\").find(\"i\").removeClass(\"unpinned\").addClass(\"pinned\");\n  }\n\n  /**\n   * Calculates the central position for the chat widget.\n   * @param {number} savedWidth - The saved width of the widget.\n   * @param {number} savedHeight - The saved height of the widget.\n   * @returns {Object} An object containing the top and left position.\n   */\n  function calculateCentralPosition(savedWidth, savedHeight) {\n    const windowWidth = $(window).width();\n    const windowHeight = $(window).height();\n    return {\n      top: (windowHeight - savedHeight) / 2,\n      left: (windowWidth - savedWidth) / 2\n    };\n  }\n\n  /**\n   * Makes the chat widget draggable.\n   */\n  function makeWidgetDraggable() {\n    $(\"#chat-widget\").draggable({\n      containment: \"window\",\n      scroll: false,\n      stop: function (event, ui) {\n        sessionStorage.setItem(\"widgetPosition\", JSON.stringify(ui.position));\n      }\n    });\n  }\n\n  /**\n   * Makes the chat widget resizable.\n   */\n  function makeWidgetResizable() {\n    $(\"#chat-widget\").resizable({\n      handles: \"n, e, s, w, ne, se, sw, nw\",\n      stop: function (event, ui) {\n        sessionStorage.setItem(\"widgetWidth\", ui.size.width);\n        sessionStorage.setItem(\"widgetHeight\", ui.size.height);\n      }\n    });\n  }\n\n  /**\n   * Loads previous chat messages from sessionStorage.\n   */\n  function loadPreviousMessages() {\n    if (chatConfig.messages.length > 0) {\n      chatConfig.messages.forEach(function (message) {\n        addMessage(message.sender, message.content, message.isUser);\n      });\n    }\n  }\n\n  /**\n   * Sets up event listeners for chat interactions.\n   */\n  function setupEventListeners() {\n    $(\"#chat-send\").on(\"click\", function () {\n      handleSendMessage();\n    });\n\n    $(\"#chat-input\").on(\"keypress\", function (e) {\n      if (e.which === 13) {\n        handleSendMessage();\n      }\n    });\n\n    $(\"#chat-reset\").on(\"click\", function () {\n      resetChat();\n    });\n\n    $('#theme_boost-drawers-blocks').on('click', '.icon.fa-xmark', function () {\n      if (!chatConfig.isPinned) {\n        handlePin(getOriginalSize());\n        chatConfig.isPinned = true;\n      }\n    });\n  }\n\n  /**\n   * Initializes the chat connection with the server.\n   */\n  function initializeChat() {\n    const data = {\n      bot_id: chatConfig.bot_id,\n      env: chatConfig.env,\n      channel: chatConfig.CHANNEL_ACRONYM,\n      username: stringToHex(chatConfig.user_name),\n    };\n    sendPostRequest(\n      chatConfig.api_base_url + \"/secure/api/connect\",\n      data,\n      handleChatConnectSuccess,\n      function () {\n        showError(chatConfig.CONECTION_FAILURE_MESSAGE);\n      },\n      chatConfig.api_token\n    );\n  }\n\n  /**\n   * Handles successful chat connection.\n   * @param {Object} connectResponse - The response from the server.\n   */\n  function handleChatConnectSuccess(connectResponse) {\n    chatConfig.token = connectResponse.data[\"token\"];\n    sessionStorage.setItem(chatConfig.tokenKey, chatConfig.token);\n    const initialMessage =\n      connectResponse.data[\"initial_response\"] || chatConfig.SUCCESS_CONECTION_MESSAGE;\n    $(\"#loading-icon\").css(\"display\", \"none\");\n    addMessage(chatConfig.bot_name, initialMessage, false);\n    storeMessage(chatConfig.bot_name, initialMessage, false);\n  }\n\n  /**\n   * Handles sending a message to the server.\n   */\n  function handleSendMessage() {\n    const userMessage = $(\"#chat-input\").val().trim();\n    if (userMessage === \"\") {\n      return;\n    }\n\n    addMessage(chatConfig.user_name, userMessage, true);\n    storeMessage(chatConfig.user_name, userMessage, true);\n\n    const data = {\n      user_input: userMessage,\n      env: chatConfig.env,\n    };\n\n    sendPostRequest(\n      chatConfig.api_base_url + \"/secure/api/message\",\n      data,\n      function (botResponse) {\n        addMessage(chatConfig.bot_name, botResponse.data.text, false);\n        storeMessage(chatConfig.bot_name, botResponse.data.text, false);\n      },\n      function () {\n        showError(chatConfig.SEND_MESSAGE_FAILURE_MESSAGE);\n      }\n    );\n\n    $(\"#chat-input\").val(\"\");\n  }\n\n  /**\n   * Resets the chat to its initial state.\n   */\n  function resetChat() {\n    $(\"#chat-messages .message\").remove();\n    $(\"#loading-icon\").css(\"display\", \"block\");\n\n    sessionStorage.removeItem(chatConfig.tokenKey);\n    sessionStorage.removeItem(chatConfig.messagesKey);\n    chatConfig.token = \"\";\n    chatConfig.messages = [];\n    initializeChat();\n  }\n\n  /**\n   * Sends a POST request to the server.\n   * @param {string} url - The URL to send the request to.\n   * @param {Object} data - The data to send in the request.\n   * @param {Function} onSuccess - Callback for successful response.\n   * @param {Function} onError - Callback for error response.\n   * @param {string} [authToken] - Optional authorization token.\n   */\n  function sendPostRequest(url, data, onSuccess, onError, authToken) {\n    $.ajax({\n      url: url,\n      type: \"POST\",\n      contentType: \"application/json\",\n      headers: {\n        'Authorization': authToken ? 'Bearer ' + authToken : 'Bearer ' + chatConfig.token\n      },\n      data: JSON.stringify(data),\n      success: function (response) {\n        if (onSuccess) {\n          onSuccess(response);\n        }\n      },\n      error: function () {\n        if (onError) {\n          onError();\n        }\n      },\n    });\n  }\n\n  /**\n   * Adds a message to the chat interface.\n   * @param {string} sender - The sender of the message.\n   * @param {string} content - The content of the message.\n   * @param {boolean} isUser - Whether the message is from the user.\n   */\n  function addMessage(sender, content, isUser) {\n    const messageDiv = $(\"<div></div>\")\n      .addClass(\"message p-2 mb-2 rounded\")\n      .html(\"<strong>\" + sender + \":</strong> \" + content);\n\n    if (isUser) {\n      messageDiv.addClass(\"bg-primary text-white\");\n    } else {\n      messageDiv.addClass(\"bg-light text-dark\");\n    }\n\n    $(\"#chat-messages\").append(messageDiv);\n    $(\"#chat-messages\").scrollTop($(\"#chat-messages\")[0].scrollHeight);\n  }\n\n  /**\n   * Stores a message in sessionStorage.\n   * @param {string} sender - The sender of the message.\n   * @param {string} content - The content of the message.\n   * @param {boolean} isUser - Whether the message is from the user.\n   */\n  function storeMessage(sender, content, isUser) {\n    chatConfig.messages.push({ sender: sender, content: content, isUser: isUser });\n    sessionStorage.setItem(chatConfig.messagesKey, JSON.stringify(chatConfig.messages));\n  }\n\n  /**\n   * Displays an error message in the chat.\n   * @param {string} errorMessage - The error message to display.\n   */\n  function showError(errorMessage) {\n    addMessage(chatConfig.bot_name, errorMessage, false);\n  }\n\n  /**\n   * Converts a string to its hexadecimal representation.\n   * @param {string} str - The string to convert.\n   * @returns {string} The hexadecimal representation of the string.\n   */\n  function stringToHex(str) {\n    if (!str) {\n      return \"\";\n    }\n\n    let hex = \"\";\n    for (let i = 0; i < str.length; i++) {\n      hex += str.charCodeAt(i).toString(16);\n    }\n    return hex;\n  }\n\n  return {\n    init: initialize,\n  };\n});\n\n\n"],"names":["require","config","paths","shim","deps","exports","define","$","ui","chatConfigModule","chatConfig","getOriginalSize","width","height","handlePin","originalSize","hide","currentWidth","currentHeight","sessionStorage","setItem","draggable","resizable","css","position","maxHeight","find","removeClass","addClass","initializeChat","data","bot_id","env","channel","CHANNEL_ACRONYM","username","stringToHex","user_name","sendPostRequest","api_base_url","handleChatConnectSuccess","showError","CONECTION_FAILURE_MESSAGE","api_token","connectResponse","token","tokenKey","initialMessage","SUCCESS_CONECTION_MESSAGE","addMessage","bot_name","storeMessage","handleSendMessage","userMessage","val","trim","user_input","botResponse","text","SEND_MESSAGE_FAILURE_MESSAGE","url","onSuccess","onError","authToken","ajax","type","contentType","headers","JSON","stringify","success","response","error","sender","content","isUser","messageDiv","html","append","scrollTop","scrollHeight","messages","push","messagesKey","errorMessage","str","hex","i","length","charCodeAt","toString","init","setChatConfig","getItem","parse","initialWidth","getInitialWidth","initialHeight","getInitialHeight","on","isPinned","toggleClass","show","savedPosition","savedWidth","savedHeight","windowWidth","window","top","left","calculateCentralPosition","containment","scroll","stop","event","handles","size","handleUnpin","setupWidgetToggle","setupWidget","forEach","message","e","which","remove","removeItem"],"mappings":"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"}