{"version":3,"file":"bgwidget.min.js","sources":["../src/bgwidget.js"],"sourcesContent":["define(['jquery'], function($) {\n  /**\n   * Initializes the chat widget.\n   */\n  function initialize() {\n    var bot_id = $(\"#chat-widget\").data(\"bot_id\");\n    var env = $(\"#chat-widget\").data(\"env\");\n    var api_token = $(\"#chat-widget\").data(\"api_token\");\n    var user_name = $(\"#chat-widget\").data(\"user_name\");\n    var bot_name = $(\"#chat-widget\").data(\"bot_name\");\n    var api_base_url = $(\"#chat-widget\").data(\"api_base_url\");\n\n    const SUCCESS_CONECTION_MESSAGE = M.util.get_string(\n      \"success_connection_message\",\n      \"block_bgwidget\"\n    );\n    const CONECTION_FAILURE_MESSAGE = M.util.get_string(\n      \"connection_failure_message\",\n      \"block_bgwidget\"\n    );\n    const SEND_MESSAGE_FAILURE_MESSAGE = M.util.get_string(\n      \"send_message_failure_message\",\n      \"block_bgwidget\"\n    );\n    const CHANNEL_ACRONYM = \"MO\";\n\n    var tokenKey = \"chatToken_\" + bot_id;\n    var messagesKey = \"chatMessages_\" + bot_id;\n    var token = sessionStorage.getItem(tokenKey) || \"\";\n    var messages = JSON.parse(sessionStorage.getItem(messagesKey)) || [];\n    let isExpanded = false;\n\n    // Save the original size of the widget to restore it later\n    var originalSize = {\n      width: $(\"#chat-widget\").width(),\n      height: $(\"#chat-widget\").height(),\n    };\n\n    // Get the saved size or use the original size\n    var initialWidth =\n      sessionStorage.getItem(\"widgetWidth\") || originalSize.width;\n    var initialHeight =\n      sessionStorage.getItem(\"widgetHeight\") || originalSize.height;\n\n    // Make the widget draggable when expanded\n    $(\"#chat-move-toggle\").on(\"click\", function () {\n      isExpanded = !isExpanded;\n\n      // Toggle the expanded class\n      $(\"#chat-widget\").toggleClass(\"expanded\", isExpanded);\n\n      if (isExpanded) {\n        // Show the unpinned message\n        $(\"#unpinned-message\").show();\n\n        // Restore saved position and size\n        var savedPosition = JSON.parse(sessionStorage.getItem(\"widgetPosition\"));\n        var savedWidth = sessionStorage.getItem(\"widgetWidth\") || initialWidth;\n        var savedHeight = sessionStorage.getItem(\"widgetHeight\") || initialHeight;\n\n        if (!savedPosition) {\n          // Calculate the central position if no saved position\n          var windowWidth = $(window).width();\n          var windowHeight = $(window).height();\n          savedPosition = {\n            top: (windowHeight - savedHeight) / 2,\n            left: (windowWidth - savedWidth) / 2\n          };\n        }\n\n        // Make it draggable if expanded\n        $(\"#chat-widget\").draggable({\n          containment: \"window\",\n          scroll: false,\n          stop: function (event, ui) {\n            sessionStorage.setItem(\"widgetPosition\", JSON.stringify(ui.position));\n          }\n        });\n\n        // Make it resizable if expanded\n        $(\"#chat-widget\").resizable({\n          handles: \"n, e, s, w, ne, se, sw, nw\",\n          stop: function (event, ui) {\n            sessionStorage.setItem(\"widgetWidth\", ui.size.width);\n            sessionStorage.setItem(\"widgetHeight\", ui.size.height);\n          }\n        });\n\n        $(\"#chat-widget\").css({\n          position: \"fixed\",\n          width: savedWidth,\n          height: savedHeight,\n          top: savedPosition.top,\n          left: savedPosition.left,\n          maxHeight: \"90vh\"\n        });\n\n        $(this).find(\"i\").removeClass(\"pinned\").addClass(\"unpinned\");\n      } else {\n        // Hide the unpinned message\n        $(\"#unpinned-message\").hide();\n\n        // Save the current size before pinning\n        var currentWidth = $(\"#chat-widget\").width();\n        var currentHeight = $(\"#chat-widget\").height();\n\n        sessionStorage.setItem(\"widgetWidth\", currentWidth);\n        sessionStorage.setItem(\"widgetHeight\", currentHeight);\n\n        $(\"#chat-widget\").draggable(\"destroy\");\n        $(\"#chat-widget\").resizable(\"destroy\");\n        $(\"#chat-widget\").css({\n          position: \"static\",\n          width: originalSize.width,\n          height: originalSize.height,\n          maxHeight: \"45vh\"\n        });\n\n        $(this).find(\"i\").removeClass(\"unpinned\").addClass(\"pinned\");\n      }\n    });\n\n    loadPreviousMessages();\n    if (!token) {\n      initializeChat();\n    }\n    setupEventListeners();\n\n    /**\n     * Loads previous messages from session storage.\n     */\n    function loadPreviousMessages() {\n      if (messages.length > 0) {\n        messages.forEach(function (message) {\n          addMessage(message.sender, message.content, message.isUser);\n        });\n      }\n    }\n\n    /**\n     * Sets up event listeners for chat interactions.\n     */\n    function setupEventListeners() {\n      $(\"#chat-send\").on(\"click\", function () {\n        handleSendMessage();\n      });\n\n      $(\"#chat-input\").on(\"keypress\", function (e) {\n        if (e.which === 13) {\n          handleSendMessage();\n        }\n      });\n\n      $(\"#chat-reset\").on(\"click\", function () {\n        resetChat();\n      });\n    }\n\n    /**\n     * Initializes the chat by connecting to the server.\n     */\n    function initializeChat() {\n      var data = {\n        bot_id: bot_id,\n        env: env,\n        channel: CHANNEL_ACRONYM,\n        username: stringToHex(user_name),\n      };\n      sendPostRequest(\n        api_base_url + \"/secure/api/connect\",\n        data,\n        handleChatConnectSuccess,\n        function () {\n          showError(CONECTION_FAILURE_MESSAGE);\n        },\n        api_token\n      );\n    }\n\n    /**\n     * Handles successful chat connection.\n     * @param {Object} connectResponse - The response from the server.\n     */\n    function handleChatConnectSuccess(connectResponse) {\n      token = connectResponse.data[\"token\"];\n      sessionStorage.setItem(tokenKey, token);\n      var initialMessage =\n        connectResponse.data[\"initial_response\"] || SUCCESS_CONECTION_MESSAGE;\n      $(\"#loading-icon\").css(\"display\", \"none\");\n      addMessage(bot_name, initialMessage, false);\n      storeMessage(bot_name, initialMessage, false);\n    }\n\n    /**\n     * Handles sending a message.\n     */\n    function handleSendMessage() {\n      var userMessage = $(\"#chat-input\").val().trim();\n      if (userMessage === \"\") {\n        return;\n      }\n\n      addMessage(user_name, userMessage, true);\n      storeMessage(user_name, userMessage, true);\n\n      var data = {\n        user_input: userMessage,\n        env: env,\n      };\n\n      sendPostRequest(\n        api_base_url + \"/secure/api/message\",\n        data,\n        function (botResponse) {\n          addMessage(bot_name, botResponse.data.text, false);\n          storeMessage(bot_name, botResponse.data.text, false);\n        },\n        function () {\n          showError(SEND_MESSAGE_FAILURE_MESSAGE);\n        }\n      );\n\n      $(\"#chat-input\").val(\"\");\n    }\n\n    /**\n     * Resets the chat to its initial state.\n     */\n    function resetChat() {\n      $(\"#chat-messages .message\").remove();\n      $(\"#loading-icon\").css(\"display\", \"block\");\n\n      sessionStorage.removeItem(tokenKey);\n      sessionStorage.removeItem(messagesKey);\n      token = \"\";\n      messages = [];\n      initializeChat();\n    }\n\n    /**\n     * Sends a POST request to the server.\n     * @param {string} url - The URL to send the request to.\n     * @param {Object} data - The data to send in the request.\n     * @param {Function} onSuccess - Callback for successful response.\n     * @param {Function} onError - Callback for error response.\n     * @param {string} authToken - The authentication token to use for the request.\n     */\n    function sendPostRequest(url, data, onSuccess, onError, authToken) {\n      $.ajax({\n        url: url,\n        type: \"POST\",\n        contentType: \"application/json\",\n        headers: {\n          'Authorization': authToken ? 'Bearer ' + authToken : 'Bearer ' + token\n        },\n        data: JSON.stringify(data),\n        success: function (response) {\n          if (onSuccess) {\n            onSuccess(response);\n          }\n        },\n        error: function () {\n          if (onError) {\n            onError();\n          }\n        },\n      });\n    }\n\n    /**\n     * Adds a message to the chat interface.\n     * @param {string} sender - The sender of the message.\n     * @param {string} content - The content of the message.\n     * @param {boolean} isUser - Whether the message is from the user.\n     */\n    function addMessage(sender, content, isUser) {\n      var messageDiv = $(\"<div></div>\")\n        .addClass(\"message p-2 mb-2 rounded\")\n        .html(\"<strong>\" + sender + \":</strong> \" + content);\n\n      if (isUser) {\n        messageDiv.addClass(\"bg-primary text-white\");\n      } else {\n        messageDiv.addClass(\"bg-light text-dark\");\n      }\n\n      $(\"#chat-messages\").append(messageDiv);\n      $(\"#chat-messages\").scrollTop($(\"#chat-messages\")[0].scrollHeight);\n    }\n\n    /**\n     * Stores a message in session storage.\n     * @param {string} sender - The sender of the message.\n     * @param {string} content - The content of the message.\n     * @param {boolean} isUser - Whether the message is from the user.\n     */\n    function storeMessage(sender, content, isUser) {\n      messages.push({ sender: sender, content: content, isUser: isUser });\n      sessionStorage.setItem(messagesKey, JSON.stringify(messages));\n    }\n\n    /**\n     * Displays an error message in the chat.\n     * @param {string} errorMessage - The error message to display.\n     */\n    function showError(errorMessage) {\n      addMessage(bot_name, errorMessage, false);\n    }\n\n    /**\n     * Converts a string to its hexadecimal representation.\n     * @param {string} str - The string to convert.\n     * @returns {string} The hexadecimal representation of the string.\n     */\n    function stringToHex(str) {\n      if (!str) {\n        return \"\";\n      }\n\n      let hex = \"\";\n      for (let i = 0; i < str.length; i++) {\n        hex += str.charCodeAt(i).toString(16);\n      }\n      return hex;\n    }\n\n    $(document).ready(function() {\n        $(\"#element\").tooltip(); // Inicializa el tooltip\n    });\n\n  }\n\n  return {\n    init: initialize,\n  };\n});\n\n\n"],"names":["define","$","init","bot_id","data","env","api_token","user_name","bot_name","api_base_url","SUCCESS_CONECTION_MESSAGE","M","util","get_string","CONECTION_FAILURE_MESSAGE","SEND_MESSAGE_FAILURE_MESSAGE","tokenKey","messagesKey","token","sessionStorage","getItem","messages","JSON","parse","isExpanded","originalSize","width","height","initialWidth","initialHeight","initializeChat","channel","username","stringToHex","sendPostRequest","handleChatConnectSuccess","showError","connectResponse","setItem","initialMessage","css","addMessage","storeMessage","handleSendMessage","userMessage","val","trim","user_input","botResponse","text","url","onSuccess","onError","authToken","ajax","type","contentType","headers","stringify","success","response","error","sender","content","isUser","messageDiv","addClass","html","append","scrollTop","scrollHeight","push","errorMessage","str","hex","i","length","charCodeAt","toString","on","toggleClass","show","savedPosition","savedWidth","savedHeight","windowWidth","window","top","left","draggable","containment","scroll","stop","event","ui","position","resizable","handles","size","maxHeight","this","find","removeClass","hide","currentWidth","currentHeight","forEach","message","e","which","remove","removeItem","document","ready","tooltip"],"mappings":"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"}