var root,factory;root="undefined"!=typeof self?self:window,factory=function($){return{init:function(){var bot_id=$("#chat-widget").data("bot_id"),env=$("#chat-widget").data("env"),user_name=$("#chat-widget").data("user_name"),bot_name=$("#chat-widget").data("bot_name"),api_base_url=$("#chat-widget").data("api_base_url");const SUCCESS_CONECTION_MESSAGE=M.util.get_string("success_connection_message","block_bgwidget"),CONECTION_FAILURE_MESSAGE=M.util.get_string("connection_failure_message","block_bgwidget"),SEND_MESSAGE_FAILURE_MESSAGE=M.util.get_string("send_message_failure_message","block_bgwidget");var tokenKey="chatToken_"+bot_id,messagesKey="chatMessages_"+bot_id,token=sessionStorage.getItem(tokenKey)||"",messages=JSON.parse(sessionStorage.getItem(messagesKey))||[];let isExpanded=!1;var originalSize={width:$("#chat-widget").width(),height:$("#chat-widget").height()},initialWidth=sessionStorage.getItem("widgetWidth")||originalSize.width,initialHeight=sessionStorage.getItem("widgetHeight")||originalSize.height;function initializeChat(){var data={bot_id:bot_id,env:env,channel:"MO",username:stringToHex(user_name)};sendPostRequest(api_base_url+"/secure/api/connect",data,handleChatConnectSuccess,(function(){showError(CONECTION_FAILURE_MESSAGE)}))}function handleChatConnectSuccess(connectResponse){token=connectResponse.data.token,sessionStorage.setItem(tokenKey,token);var initialMessage=connectResponse.data.initial_response||SUCCESS_CONECTION_MESSAGE;$("#loading-icon").css("display","none"),addMessage(bot_name,initialMessage,!1),storeMessage(bot_name,initialMessage,!1)}function handleSendMessage(){var userMessage=$("#chat-input").val().trim();""!==userMessage&&(addMessage(user_name,userMessage,!0),storeMessage(user_name,userMessage,!0),sendPostRequest(api_base_url+"/secure/api/message",{user_input:userMessage,env:env},(function(botResponse){addMessage(bot_name,botResponse.data.text,!1),storeMessage(bot_name,botResponse.data.text,!1)}),(function(){showError(SEND_MESSAGE_FAILURE_MESSAGE)})),$("#chat-input").val(""))}function sendPostRequest(url,data,onSuccess,onError){$.ajax({url:url,type:"POST",contentType:"application/json",headers:{Authorization:"Bearer "+token},data:JSON.stringify(data),success:function(response){onSuccess&&onSuccess(response)},error:function(){onError&&onError()}})}function addMessage(sender,content,isUser){var messageDiv=$("<div></div>").addClass("message p-2 mb-2 rounded").html("<strong>"+sender+":</strong> "+content);isUser?messageDiv.addClass("bg-primary text-white"):messageDiv.addClass("bg-light text-dark"),$("#chat-messages").append(messageDiv),$("#chat-messages").scrollTop($("#chat-messages")[0].scrollHeight)}function storeMessage(sender,content,isUser){messages.push({sender:sender,content:content,isUser:isUser}),sessionStorage.setItem(messagesKey,JSON.stringify(messages))}function showError(errorMessage){addMessage(bot_name,errorMessage,!1)}function stringToHex(str){if(!str)return"";let hex="";for(let i=0;i<str.length;i++)hex+=str.charCodeAt(i).toString(16);return hex}$("#chat-move-toggle").on("click",(function(){isExpanded=!isExpanded,$("#chat-widget").toggleClass("expanded",isExpanded),isExpanded?($("#chat-widget").draggable({containment:"window",scroll:!1}),$("#chat-widget").resizable({handles:"n, e, s, w, ne, se, sw, nw",stop:function(event,ui){sessionStorage.setItem("widgetWidth",ui.size.width),sessionStorage.setItem("widgetHeight",ui.size.height)}}),$("#chat-widget").css({position:"fixed",width:initialWidth,height:initialHeight}),$(this).find("i").removeClass("fa-expand").addClass("fa-compress")):($("#chat-widget").draggable("destroy"),$("#chat-widget").resizable("destroy"),$("#chat-widget").width(originalSize.width),$("#chat-widget").height(originalSize.height),$("#chat-widget").css({position:"static"}),$(this).find("i").removeClass("fa-compress").addClass("fa-expand"))})),messages.length>0&&messages.forEach((function(message){addMessage(message.sender,message.content,message.isUser)})),token||initializeChat(),$("#chat-send").on("click",(function(){handleSendMessage()})),$("#chat-input").on("keypress",(function(e){13===e.which&&handleSendMessage()})),$("#chat-reset").on("click",(function(){$("#chat-messages .message").remove(),$("#loading-icon").css("display","block"),sessionStorage.removeItem(tokenKey),sessionStorage.removeItem(messagesKey),token="",messages=[],initializeChat()}))}}},"function"==typeof define&&define.amd?define("block_bgwidget/bgwidget",["jquery","jqueryui"],factory):"object"==typeof module&&module.exports?module.exports=factory(require("jquery"),require("jquery-ui-dist")):root.bgwidget=factory(root.jQuery);

//# sourceMappingURL=bgwidget.min.js.map